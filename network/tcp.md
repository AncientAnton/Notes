# TCP/IP详解 卷1：协议

TCP/IP ILLustrated Volume 1: The Protocols，ISBN: 9787111075660

# 第一章 概述

* 分层
    * 应用层
    * 运输层 TCP/UPD
    * 网络层 IP/ICMP/IGMP
    * 链路层 ARP/RARP
    * 物理层 DOCSIS
* IP地址
    * 32位
    * A类 0|7位网络号|24位主机号
    * B类 10|14位网络号|16位主机号
    * C类 110|21位网络号|8位主机号
    * D类 1110|28位多播组号
    * E类 11110|27位
* RFC文档

# 第十七章TCP：传输控制协议

## 17.1 TCP报文结构

```
0                   1                   2                   3
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|          Source Port          |       Destination Port        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                        Sequence Number                        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Acknowledgment Number                      |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|  Data |           |U|A|P|R|S|F|                               |
| Offset| Reserved  |R|C|S|S|Y|I|            Window             |
|       |           |G|K|H|T|N|N|                               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|           Checksum            |         Urgent Pointer        |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                    Options                    |    Padding    |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|                             data                              |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

* 16位源端口
* 16位目标端口
* 32位序列号（将数据按字节进行编号，例如第一个包0，第二个包1000）
* 32位确认号（已确认接受到的字节编号）
* 4位首部长度（以32Bit为单位，首部大小最多15*32=480bit=60byte）
* 6位保留未用
    * 必须为0
* 6位控制位
    * URG:  紧急指针有效
    * ACK:  确认序号有效
    * PSH:  尽快交付到应用层
    * RST:  重建连接
    * SYN:  同步序列号，用于建立连接
    * FIN:  完成传输任务
* 16位窗口大小（窗口最大65535个字节）
* 16位校验和
* 16位紧急指针（telnet/ftp中有使用，后续建议不再使用）
* 可选且变长的选项（调节MSS）
* 补全（补全到32位的倍数）
* 数据

# 第十八章 TCP连接的建立与终止

## 18.1 建立连接

三次握手

1. 客户端发送 SYN = 1，SEQ = seq1
2. 服务端响应 SYN = 1，SEQ = seq2，ACK = 1，ACKN = seq1 + 1
3. 客户端响应 ACK = 1，ACKN = seq2 + 1

## 18.2 终止连接

四次挥手

1. 客户端发送 FIN = 1，SEQ = seq1
2. 服务端响应 ACK = 1，SEQ = seq2，ACKN = seq1 + 1
3. 服务端发送 FIN = 1，SEQ = seq3
4. 客户端响应 ACK = 1，ACKN = seq3 + 1

## 18.3 TCP连接的状态

* CLOSED：初始状态，没有任何连接。
* LISTEN：正在监听连接请求。
* SYN_SENT：主动发起连接请求，等待ACK。
* SYN_RECEIVED：收到一个连接请求，等待ACK。
* ESTABLISHED：收到ACK，连接已经建立。
* FIN_WAIT_1：主动关闭连接，等待ACK。能读取数据，但不能发送数据。
* FIN_WAIT_2：主动关闭连接，收到ACK。等待FIN。
* TIME_WAIT：主动关闭连接，收到FIN，返回ACK。然后等待2MSL（Maximum Segement Lifttime）确保对方接收到ACK包，最后回到CLOSED状态。
* CLOSE_WAIT：被动关闭连接，收到FIN，返回ACK。可以发送，但不能再读取数据。
* LAST_ACK：被动关闭连接，发送FIN，等待ACK。收到ACK后，回到CLOSED状态。
* CLOSING：同时关闭的情况，发送FIN后，同时收到了对方的FIN。

**握手流程**

```
Client      |                    | Server
            |                    |
SYN_SENT    |     -- SYN -->     |
            |                    | SYN_RECEIVED
            | <-- SYN + ACK --   |
ESTABLISHED |                    |
            |     -- ACK -->     |
            |                    | ESTABLISHED
```

**挥手流程变化**

```
Client      |                    | Server
            |                    |
FIN_WAIT1   |     -- FIN -->     |
            |                    | CLOSE_WAIT
            |    <-- ACK --      |
FIN_WAIT2   |                    |
            |    <-- FIN --      | 
            |                    | LAST_ACK
TIME_WAIT   |     -- ACK -->     |
            |                    | 
            |                    | CLOSED
CLOSED      |                    | 
```

# 第十九章 TCP的交互数据流

# 第二十章 TCP的成块数据流

# 第二十一章 TCP的超时与重传

# 第二十二章 TCP的持久定时器

# 第二十三章 TCP的保活定时器